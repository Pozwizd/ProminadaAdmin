<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{template/layout.html}">

<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center py-3 mb-4">
        <h4 class="fw-bold m-0" data-i18n="personal.createUser">Создать пользователя</h4>
    </div>

    <div class="row">
        <div class="col-12"> <!-- Changed from col-xl-auto to make tabs full width -->
            <div class="nav-align-top mb-4">
                <ul class="nav nav-pills mb-3" role="tablist">
                    <li class="nav-item">
                        <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab"
                                data-bs-target="#informationPersonal" aria-controls="informationPersonal"
                                aria-selected="true">
                            Информация
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab" data-bs-toggle="tab"
                                data-bs-target="#testimonialsPersonal" aria-controls="testimonialsPersonal"
                                aria-selected="false">
                            Отзывы
                        </button>
                    </li>

                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="informationPersonal" role="tabpanel">
                        <div class="card-body">
                            <div class="d-flex align-items-start align-items-sm-center gap-4">
                                <img th:src="@{/assets/img/avatars/14.png}" alt="user-avatar"
                                     class="d-block w-px-100 h-px-100 rounded" id="uploadedAvatar"/>
                                <div class="button-wrapper">
                                    <label for="upload" class="btn btn-primary me-2 mb-3" tabindex="0">
                                        <span class="d-none d-sm-block">Upload new photo</span>
                                        <i class="ti ti-upload d-block d-sm-none"></i>
                                        <input type="file" id="upload" class="account-file-input" hidden
                                               accept="image/png, image/jpeg"/>
                                    </label>
                                    <button type="button" class="btn btn-label-secondary account-image-reset mb-3">
                                        <i class="ti ti-refresh-dot d-block d-sm-none"></i>
                                        <span class="d-none d-sm-block">Reset</span>
                                    </button>
                                    <div class="text-muted">Allowed JPG, GIF or PNG. Max size of 800K</div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-3"/>
                        <!-- /Account -->
                        <div class="card-body">
                            <form id="formAdminUserProfile" method="POST" onsubmit="return false">
                                <input type="hidden" id="userId" name="userId"/>
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <label for="select2Primary" class="form-label">Primary</label>
                                        <div class="select2-primary">
                                            <select id="select2Primary" class="select2 form-select" multiple>
                                                <option value="1" selected>Option1</option>
                                                <option value="2" selected>Option2</option>
                                                <option value="3">Option3</option>
                                                <option value="4">Option4</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="role" class="form-label">Роль</label>
                                        <select id="role" name="role" class="form-select">
                                            <option value="ADMIN">Администратор</option>
                                            <option value="SUPER_ADMIN">Супер Администратор</option>
                                            <option value="MODERATOR">Модератор</option>
                                            <option value="MANAGER">Менеджер</option>
                                        </select>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="surname" class="form-label">Фамилия</label>
                                        <input class="form-control" type="text" id="surname" name="surname"/>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="name" class="form-label">Имя</label>
                                        <input class="form-control" type="text" id="name" name="name" required/>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="lastName" class="form-label">Отчество</label>
                                        <input class="form-control" type="text" id="lastName" name="lastName"
                                               required/>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="phoneNumber" class="form-label">Номер телефона</label>
                                        <input type="text" class="form-control" id="phoneNumber" name="phoneNumber"
                                               placeholder="202 555 0111"/>
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        <label for="email" class="form-label">E-mail</label>
                                        <input class="form-control" type="email" id="email" name="email" required
                                               pattern="^(.+)@(.+)$" placeholder="example@example.com"/>
                                    </div>

                                    <hr class="my-0"/>
                                    <div class="mb-3 col-md-6">
                                        <label for="password" class="form-label">Пароль</label>
                                        <input type="password" class="form-control" id="password" name="password"
                                               placeholder="••••••••"/>
                                    </div>

                                    <div class="mb-3 col-md-6">
                                        <label for="confirmPassword" class="form-label">Подтверждение пароля</label>
                                        <input type="password" class="form-control" id="confirmPassword"
                                               name="confirmPassword" placeholder="••••••••"/>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                    <div class="tab-pane fade" id="testimonialsPersonal" role="tabpanel">
                        <div class="card-body">
                            <!-- File Upload Section -->
                            <div class="mb-4">
                                <label class="form-label d-block">Прикрепить PDF файлы</label>
                                <label class="btn btn-secondary me-2">
                                    Выбрать файл
                                    <input type="file" id="pdfUpload" accept=".pdf" multiple hidden>
                                </label>
                                <span id="pdfUploadStatus">Файл не выбран</span>

                                <!-- Placeholder for uploaded file list -->
                                <div id="uploadedFilesList" class="mt-3">
                                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                                            <span class="d-flex align-items-center">
                                                <i class="ti ti-file-text me-2"></i>
                                                Документ_1.pdf
                                            </span>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-icon btn-sm btn-outline-primary" title="Скачать">
                                                <i class="ti ti-download"></i>
                                            </button>
                                            <button class="btn btn-icon btn-sm btn-outline-danger" title="Удалить">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                                            <span class="d-flex align-items-center">
                                                <i class="ti ti-file-text me-2"></i>
                                                Документ_2.pdf
                                            </span>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-icon btn-sm btn-outline-primary" title="Скачать">
                                                <i class="ti ti-download"></i>
                                            </button>
                                            <button class="btn btn-icon btn-sm btn-outline-danger" title="Удалить">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-2" role="alert">
                                        Если загружен файл, его можно скачать для просмотра или удалить.
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4"/>

                            <!-- Repeatable Form Section Wrapper (for potential JS additions) -->
                            <div id="reviewSectionsContainer">
                                <!-- Repeatable Form Section 1 -->
                                <div class="review-section mb-4 border p-3 rounded position-relative">
                                    <input type="hidden" class="feedback-id" value="">
                                    <button type="button"
                                            class="btn btn-icon btn-sm btn-outline-danger position-absolute top-0 end-0 mt-2 me-2"
                                            title="Удалить отзыв" onclick="removeReviewSection(this)">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="reviewerName1" class="form-label">Имя</label>
                                            <input type="text" class="form-control" id="reviewerName1"
                                                   value="Алексей">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="reviewerContact1" class="form-label">Контакт</label>
                                            <input type="text" class="form-control" id="reviewerContact1"
                                                   value="+380991112233">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reviewText1" class="form-label">Отзыв</label>
                                        <textarea class="form-control" id="reviewText1" rows="3"></textarea>
                                    </div>
                                </div>
                                <!-- End Repeatable Section 1 -->

                                <!-- Repeatable Form Section 2 -->
                                <div class="review-section mb-4 border p-3 rounded position-relative">
                                    <input type="hidden" class="feedback-id" value="">
                                    <button type="button"
                                            class="btn btn-icon btn-sm btn-outline-danger position-absolute top-0 end-0 mt-2 me-2"
                                            title="Удалить отзыв" onclick="removeReviewSection(this)">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="reviewerName2" class="form-label">Имя</label>
                                            <input type="text" class="form-control" id="reviewerName2"
                                                   value="Алексей">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="reviewerContact2" class="form-label">Контакт</label>
                                            <input type="text" class="form-control" id="reviewerContact2"
                                                   value="+380991112233">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reviewText2" class="form-label">Отзыв</label>
                                        <textarea class="form-control" id="reviewText2" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="navs-pills-top-messages" role="tabpanel">
                        <!-- Content for Messages tab can go here -->
                        <p>Messages tab content placeholder.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-2 d-flex justify-content-end">
            <button type="reset" class="btn btn-label-secondary">Отмена</button>
            <button type="submit" class="btn btn-primary me-2">Сохранить изменения</button>
        </div>

        <!-- Modal for Review Deletion Confirmation -->
        <div class="modal fade" id="deleteReviewConfirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteReviewConfirmModalLabel">
                            Подтверждение удаления</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <span>Вы уверены, что хотите удалить этот отзыв?</span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-label-secondary"
                                data-bs-dismiss="modal">Отменить
                        </button>
                        <button type="button" class="btn btn-danger" id="confirm-delete-review-btn">
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/assets/vendor/libs/select2/select2.js}"></script>
    <script th:src="@{/assets/js/forms-selects.js}"></script>
    <script th:src="@{/assets/axios.min.js}"></script>
    <script th:inline="javascript">
        const contextPath = '[[@{/}]]'.replaceAll('"', '');
        const defaultAvatarPath = '[[@{/assets/img/avatars/14.png}]]';
        console.log(contextPath)
        document.addEventListener('DOMContentLoaded', function () {
            console.log(contextPath)
            const userId = new URLSearchParams(window.location.search).get('id') ||
                window.location.pathname.split('/').filter(Boolean).pop();
            const isEditMode = Boolean(userId);
            console.log(isEditMode)
            if (isEditMode) {
                loadPersonalData(userId);

            }

            setupFormSubmission();
            setupFileUpload();
        });

        async function loadPersonalData(userId) {
            try {
                console.log(`${contextPath}personal/${userId}`)
                const response = await axios.get(`${contextPath}personal/${userId}`);
                console.log(response)
                fillFormData(response.data);
            } catch (error) {
                console.error('Error loading personal data:', error);
            }
        }

        function fillFormData(data) {
            // Заполнение основной информации
            document.getElementById('userId').value = data.id;
            document.getElementById('surname').value = data.surname || '';
            document.getElementById('name').value = data.name || '';
            document.getElementById('lastName').value = data.lastName || '';
            document.getElementById('phoneNumber').value = data.phoneNumber || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('role').value = data.role || 'MANAGER';

            // Если есть аватар
            if (data.pathAvatar) {
                document.getElementById('uploadedAvatar').src = data.pathAvatar;
            }

            // Заполнение отзывов
            if (data.feedBacks && data.feedBacks.length > 0) {
                const container = document.getElementById('reviewSectionsContainer');
                container.innerHTML = ''; // Очищаем существующие отзывы

                data.feedBacks.forEach((feedback, index) => {
                    const reviewSection = createReviewSection(index + 1, feedback);
                    container.appendChild(reviewSection);
                });
            }

            // Заполнение документов
            if (data.documentFeedbacks && data.documentFeedbacks.length > 0) {
                const filesList = document.getElementById('uploadedFilesList');
                filesList.innerHTML = ''; // Очищаем существующий список

                data.documentFeedbacks.forEach(doc => {
                    const fileItem = createFileListItem(doc);
                    filesList.appendChild(fileItem);
                });
            }
        }

        function createReviewSection(index, feedback = {}) {
            const section = document.createElement('div');
            section.className = 'review-section mb-4 border p-3 rounded position-relative';
            section.innerHTML = `
        <input type="hidden" class="feedback-id" value="${feedback.id || ''}">
        <button type="button" class="btn btn-icon btn-sm btn-outline-danger position-absolute top-0 end-0 mt-2 me-2"
                title="Удалить отзыв" onclick="removeReviewSection(this)">
            <i class="ti ti-trash"></i>
        </button>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="reviewerName${index}" class="form-label">Имя</label>
                <input type="text" class="form-control" id="reviewerName${index}" value="${feedback.name || ''}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="reviewerContact${index}" class="form-label">Контакт</label>
                <input type="text" class="form-control" id="reviewerContact${index}" value="${feedback.phoneNumber || ''}">
            </div>
        </div>
        <div class="mb-3">
            <label for="reviewText${index}" class="form-label">Отзыв</label>
            <textarea class="form-control" id="reviewText${index}" rows="3">${feedback.text || ''}</textarea>
        </div>
    `;
            return section;
        }

        function createFileListItem(doc) {
            const item = document.createElement('div');
            item.className = 'd-flex align-items-center justify-content-between p-2 border rounded mb-2';
            item.innerHTML = `
        <span class="d-flex align-items-center">
            <i class="ti ti-file-text me-2"></i>
            ${doc.fileName || 'Document'}
        </span>
        <div class="d-flex gap-2">
            <button class="btn btn-icon btn-sm btn-outline-primary" title="Скачать"
                    onclick="downloadDocument('${doc.id}')">
                <i class="ti ti-download"></i>
            </button>
            <button class="btn btn-icon btn-sm btn-outline-danger" title="Удалить"
                    onclick="deleteDocument('${doc.id}')">
                <i class="ti ti-trash"></i>
            </button>
        </div>
    `;
            return item;
        }

        function setupFormSubmission() {
            const form = document.getElementById('formAdminUserProfile');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(form);
                const userId = formData.get('userId');
                const url = `${contextPath}personal${userId ? `/${userId}` : ''}`;
                const method = userId ? 'put' : 'post';

                try {
                    const response = await axios[method](url, Object.fromEntries(formData), {
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    window.location.href = `${contextPath}personal`;
                } catch (error) {
                    console.error('Error saving personal data:', error);
                }
            });
        }

        function setupFileUpload() {
            const upload = document.getElementById('upload');
            const uploadedAvatar = document.getElementById('uploadedAvatar');
            const resetButton = document.querySelector('.account-image-reset');
            const pdfUpload = document.getElementById('pdfUpload');
            const pdfUploadStatus = document.getElementById('pdfUploadStatus');

            if (upload) {
                upload.onchange = () => {
                    if (upload.files[0]) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            uploadedAvatar.src = e.target.result;
                        };
                        reader.readAsDataURL(upload.files[0]);
                    }
                };
            }

            if (resetButton) {
                resetButton.onclick = () => {
                    uploadedAvatar.src = defaultAvatarPath;
                };
            }

            if (pdfUpload) {
                pdfUpload.onchange = () => {
                    const files = Array.from(pdfUpload.files);
                    pdfUploadStatus.textContent = files.length > 0
                        ? `Выбрано файлов: ${files.length}`
                        : 'Файл не выбран';
                };
            }
        }

        async function downloadDocument(docId) {
            try {
                const response = await axios.get(`${contextPath}personal/documents/${docId}/download`, {
                    responseType: 'blob'
                });

                const blob = response.data;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'document.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Error downloading document:', error);
            }
        }

        async function deleteDocument(docId) {
            if (!confirm('Вы уверены, что хотите удалить этот документ?')) return;

            try {
                await axios.delete(`${contextPath}personal/documents/${docId}`);
                const fileItem = document.querySelector(`[onclick*="${docId}"]`).closest('.d-flex');
                fileItem.remove();
            } catch (error) {
                console.error('Error deleting document:', error);
            }
        }

        let currentReviewButton = null;

        function removeReviewSection(button) {
            // Сохраняем ссылку на кнопку, которая была нажата
            currentReviewButton = button;

            // Показываем модальное окно подтверждения
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteReviewConfirmModal'));
            deleteModal.show();
        }

        // Обработчик для кнопки подтверждения удаления в модальном окне
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('confirm-delete-review-btn').addEventListener('click', function () {
                if (currentReviewButton) {
                    const section = currentReviewButton.closest('.review-section');
                    const feedbackId = section.querySelector('.feedback-id').value;

                    // Если у отзыва есть ID, можно добавить здесь запрос на удаление с сервера
                    // if (feedbackId) {
                    //     axios.delete(`${contextPath}personal/feedback/${feedbackId}`);
                    // }

                    section.remove();

                    // Закрываем модальное окно
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteReviewConfirmModal'));
                    deleteModal.hide();

                    // Сбрасываем ссылку на текущую кнопку
                    currentReviewButton = null;
                }
            });
        });

    </script>
</div>

</body>

</html>